<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Cocina - Pedidos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/socket.io/socket.io.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        .order-card { 
            animation: slideIn 0.3s ease-out;
            transition: all 0.2s ease;
        }
        .order-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes pulse-ring {
            0% { transform: scale(0.8); opacity: 0.5; }
            100% { transform: scale(1.3); opacity: 0; }
        }
        
        .pulse-ring::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: inherit;
            animation: pulse-ring 2s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
        }
        
        .column-drop { min-height: 200px; }
        
        .timer {
            font-variant-numeric: tabular-nums;
        }
        
        .urgent {
            animation: urgent-pulse 1s ease-in-out infinite;
        }
        
        @keyframes urgent-pulse {
            0%, 100% { background-color: rgb(254 226 226); }
            50% { background-color: rgb(254 202 202); }
        }
        
        .print-area {
            display: none;
        }
        
        @media print {
            .no-print { display: none !important; }
            .print-area { 
                display: block !important;
                page-break-after: always;
            }
        }
        
        .dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }
        
        .drag-over {
            background-color: rgba(59, 130, 246, 0.1);
            border: 2px dashed #3b82f6;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Verificaci√≥n de sesi√≥n -->
    <script>
        (function() {
            fetch('/api/check-auth')
                .then(res => res.json())
                .then(data => {
                    if (!data.authenticated) {
                        window.location.replace('/login');
                    }
                })
                .catch(() => {
                    window.location.replace('/login');
                });
        })();
    </script>

    <div class="max-w-7xl mx-auto p-4 md:p-6">
        <!-- Header Mejorado -->
        <header class="mb-6 flex flex-col md:flex-row justify-between items-start md:items-center gap-4 no-print">
            <div class="flex items-center gap-4">
                <div class="w-14 h-14 bg-orange-500 rounded-full flex items-center justify-center shadow-lg">
                    <i class="fas fa-utensils text-white text-2xl"></i>
                </div>
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">üë®‚Äçüç≥ Panel de Cocina</h1>
                    <p class="text-gray-600 mt-1" id="stats-summary">Cargando estad√≠sticas...</p>
                </div>
            </div>
            
            <div class="flex items-center gap-3 flex-wrap">
                <!-- Buscador -->
                <div class="relative">
                    <input type="text" id="search-input" placeholder="Buscar pedido..." 
                           class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none w-48"
                           oninput="filterOrders()">
                    <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                </div>
                
                <!-- Filtro de mesa -->
                <select id="table-filter" onchange="filterOrders()" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                    <option value="">Todas las mesas</option>
                </select>
                
                <!-- Estado de conexi√≥n -->
                <div id="connection-status" class="flex items-center gap-2 px-3 py-2 rounded-full bg-red-100 text-red-800 text-sm">
                    <span class="w-2 h-2 bg-red-500 rounded-full"></span>
                    <span>Desconectado</span>
                </div>
                
                <button onclick="loadOrders()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm transition-colors">
                    <i class="fas fa-sync-alt mr-2"></i>Actualizar
                </button>
                
                <button onclick="toggleSound()" id="sound-btn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 text-sm transition-colors">
                    <i class="fas fa-volume-up mr-2"></i>Sonido
                </button>
                
                <button onclick="logout()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 text-sm transition-colors">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </header>

        <!-- Estad√≠sticas en tiempo real -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6 no-print">
            <div class="bg-white rounded-xl shadow-sm p-4 border-l-4 border-yellow-500">
                <div class="text-sm text-gray-600">Tiempo promedio</div>
                <div class="text-2xl font-bold text-gray-900" id="avg-time">--</div>
            </div>
            <div class="bg-white rounded-xl shadow-sm p-4 border-l-4 border-blue-500">
                <div class="text-sm text-gray-600">En preparaci√≥n</div>
                <div class="text-2xl font-bold text-blue-600" id="stat-preparing">0</div>
            </div>
            <div class="bg-white rounded-xl shadow-sm p-4 border-l-4 border-green-500">
                <div class="text-sm text-gray-600">Completados hoy</div>
                <div class="text-2xl font-bold text-green-600" id="stat-completed">0</div>
            </div>
            <div class="bg-white rounded-xl shadow-sm p-4 border-l-4 border-purple-500">
                <div class="text-sm text-gray-600">Ventas totales</div>
                <div class="text-2xl font-bold text-purple-600" id="stat-sales">$0</div>
            </div>
        </div>

        <!-- Kanban Board -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6 no-print">
            <!-- Pendientes -->
            <div class="bg-white rounded-xl shadow-sm p-4" ondrop="drop(event, 'preparing')" ondragover="allowDrop(event)" ondragleave="leaveDrop(event)">
                <div class="flex items-center justify-between mb-4 pb-2 border-b-2 border-yellow-400">
                    <h2 class="font-bold text-gray-700 flex items-center gap-2">
                        <span class="relative w-3 h-3 bg-yellow-500 rounded-full">
                            <span class="absolute inset-0 bg-yellow-500 rounded-full animate-ping"></span>
                        </span>
                        Pendientes
                    </h2>
                    <span id="count-pending" class="bg-yellow-100 text-yellow-800 text-sm px-2 py-1 rounded-full font-bold">0</span>
                </div>
                <div id="orders-pending" class="space-y-3 column-drop"></div>
            </div>

            <!-- En Preparaci√≥n -->
            <div class="bg-white rounded-xl shadow-sm p-4" ondrop="drop(event, 'ready')" ondragover="allowDrop(event)" ondragleave="leaveDrop(event)">
                <div class="flex items-center justify-between mb-4 pb-2 border-b-2 border-blue-400">
                    <h2 class="font-bold text-gray-700 flex items-center gap-2">
                        <span class="w-3 h-3 bg-blue-500 rounded-full"></span>
                        En Preparaci√≥n
                    </h2>
                    <span id="count-preparing" class="bg-blue-100 text-blue-800 text-sm px-2 py-1 rounded-full font-bold">0</span>
                </div>
                <div id="orders-preparing" class="space-y-3 column-drop"></div>
            </div>

            <!-- Listos -->
            <div class="bg-white rounded-xl shadow-sm p-4" ondrop="drop(event, 'delivered')" ondragover="allowDrop(event)" ondragleave="leaveDrop(event)">
                <div class="flex items-center justify-between mb-4 pb-2 border-b-2 border-green-400">
                    <h2 class="font-bold text-gray-700 flex items-center gap-2">
                        <span class="w-3 h-3 bg-green-500 rounded-full"></span>
                        Listos
                    </h2>
                    <span id="count-ready" class="bg-green-100 text-green-800 text-sm px-2 py-1 rounded-full font-bold">0</span>
                </div>
                <div id="orders-ready" class="space-y-3 column-drop"></div>
            </div>
        </div>
    </div>

    <!-- √Årea de impresi√≥n oculta -->
    <div id="print-area" class="print-area"></div>

    <!-- Modal de detalle de pedido -->
    <div id="order-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4 no-print">
        <div class="bg-white rounded-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto p-6 shadow-2xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Detalle del Pedido</h3>
                <button onclick="closeModal()" class="p-2 hover:bg-gray-100 rounded-full">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="modal-content"></div>
        </div>
    </div>

    <!-- Audio para notificaciones -->
    <audio id="notif-sound" preload="auto">
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBTGH0fPTgjMGHm7A7+OZSA0PVanu8LdnGwU1kNbxz4AzBB9uwfDhlE" type="audio/wav">
    </audio>

    <script>
        const socket = io();
        let orders = [];
        let soundEnabled = true;
        let timers = {};
        let currentFilter = '';
        let currentTableFilter = '';

        // Inicializaci√≥n
        socket.on('connect', () => {
            updateStatus(true);
            socket.emit('join:kitchen');
            loadOrders();
            loadTables();
        });

        socket.on('disconnect', () => updateStatus(false));

        // Nuevo pedido con notificaci√≥n mejorada
        socket.on('order:new', (order) => {
            orders.unshift(order);
            renderOrders();
            updateStats();
            if (soundEnabled) {
                playSound();
                showBrowserNotification('üîî Nuevo pedido', `Mesa ${order.table_code} - $${order.total}`);
            }
            showToast(`Nuevo pedido #${order.id} - Mesa ${order.table_code}`, 'info');
        });

        socket.on('order:updated', () => {
            loadOrders();
        });

        // Funciones de autenticaci√≥n
        async function logout() {
            try {
                await fetch('/logout', { method: 'POST' });
                window.location.replace('/login-cocina');
            } catch (err) {
                window.location.replace('/login-cocina');
            }
        }

        // Estado de conexi√≥n visual
        function updateStatus(connected) {
            const el = document.getElementById('connection-status');
            if (connected) {
                el.className = 'flex items-center gap-2 px-3 py-2 rounded-full bg-green-100 text-green-800 text-sm font-medium';
                el.innerHTML = '<span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span><span>En vivo</span>';
            } else {
                el.className = 'flex items-center gap-2 px-3 py-2 rounded-full bg-red-100 text-red-800 text-sm font-medium';
                el.innerHTML = '<span class="w-2 h-2 bg-red-500 rounded-full"></span><span>Desconectado</span>';
            }
        }

        // Cargar datos
        async function loadOrders() {
            try {
                const res = await fetch('/api/orders');
                if (res.status === 401) {
                    window.location.replace('/login-cocina');
                    return;
                }
                orders = await res.json();
                renderOrders();
                updateStats();
                updateTableFilter();
            } catch (err) {
                console.error('Error cargando √≥rdenes:', err);
                showToast('Error de conexi√≥n', 'error');
            }
        }

        async function loadTables() {
            try {
                const res = await fetch('/api/data');
                const data = await res.json();
                const select = document.getElementById('table-filter');
                select.innerHTML = '<option value="">Todas las mesas</option>';
                data.tables.forEach(t => {
                    select.innerHTML += `<option value="${t.code}">Mesa ${t.code}</option>`;
                });
            } catch (err) {
                console.error('Error cargando mesas:', err);
            }
        }

        // Filtrado
        function filterOrders() {
            currentFilter = document.getElementById('search-input').value.toLowerCase();
            currentTableFilter = document.getElementById('table-filter').value;
            renderOrders();
        }

        function updateTableFilter() {
            const select = document.getElementById('table-filter');
            const currentTables = Array.from(select.options).map(o => o.value);
            const orderTables = [...new Set(orders.map(o => o.table_code))];
            
            orderTables.forEach(code => {
                if (!currentTables.includes(code)) {
                    select.innerHTML += `<option value="${code}">Mesa ${code}</option>`;
                }
            });
        }

        // Renderizado principal
        function renderOrders() {
            // Limpiar timers anteriores
            Object.values(timers).forEach(t => clearInterval(t));
            timers = {};

            let filteredOrders = orders;

            // Aplicar filtros
            if (currentFilter) {
                filteredOrders = filteredOrders.filter(o => 
                    o.id.toString().includes(currentFilter) ||
                    o.table_code.toLowerCase().includes(currentFilter) ||
                    o.items.some(i => i.product_name.toLowerCase().includes(currentFilter))
                );
            }

            if (currentTableFilter) {
                filteredOrders = filteredOrders.filter(o => o.table_code === currentTableFilter);
            }

            const pending = filteredOrders.filter(o => o.status === 'pending');
            const preparing = filteredOrders.filter(o => o.status === 'preparing');
            const ready = filteredOrders.filter(o => o.status === 'ready');

            document.getElementById('count-pending').textContent = pending.length;
            document.getElementById('count-preparing').textContent = preparing.length;
            document.getElementById('count-ready').textContent = ready.length;

            document.getElementById('orders-pending').innerHTML = pending.map(o => renderCard(o, 'pending')).join('');
            document.getElementById('orders-preparing').innerHTML = preparing.map(o => renderCard(o, 'preparing')).join('');
            document.getElementById('orders-ready').innerHTML = ready.map(o => renderCard(o, 'ready')).join('');
        }

        function renderCard(order, status) {
            const time = new Date(order.createdAt);
            const now = new Date();
            const diffMinutes = Math.floor((now - time) / 60000);
            const isUrgent = diffMinutes > 15 && status === 'pending';
            const isWarning = diffMinutes > 10 && status === 'preparing';

            const actions = {
                pending: { next: 'preparing', label: 'Iniciar', color: 'bg-blue-600', icon: 'fa-play' },
                preparing: { next: 'ready', label: 'Completar', color: 'bg-green-600', icon: 'fa-check' },
                ready: { next: 'delivered', label: 'Entregar', color: 'bg-gray-600', icon: 'fa-archive' }
            };
            const action = actions[status];

            // Timer ID para actualizaci√≥n en tiempo real
            const timerId = `timer-${order.id}`;
            
            return `
                <div class="order-card bg-gray-50 p-4 rounded-lg border-l-4 ${status === 'pending' ? 'border-yellow-500' : status === 'preparing' ? 'border-blue-500' : 'border-green-500'} ${isUrgent ? 'urgent border-red-500' : ''} ${isWarning ? 'bg-orange-50' : ''}"
                     draggable="true" 
                     ondragstart="drag(event, ${order.id})"
                     onclick="showOrderDetail(${order.id})">
                    
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <span class="font-bold text-lg text-gray-900">#${order.id}</span>
                            <span class="text-sm font-semibold text-orange-600 ml-2">Mesa ${order.table_code}</span>
                        </div>
                        <div class="text-right">
                            <div class="text-xs font-mono timer ${isUrgent ? 'text-red-600 font-bold' : 'text-gray-500'}" id="${timerId}">
                                ${formatTime(diffMinutes)}
                            </div>
                            <div class="text-xs text-gray-400">${time.toLocaleTimeString()}</div>
                        </div>
                    </div>
                    
                    <div class="space-y-1 mb-3 text-sm">
                        ${order.items.slice(0, 3).map(i => `
                            <div class="flex justify-between items-center">
                                <span class="${i.quantity > 1 ? 'font-semibold text-gray-900' : 'text-gray-700'}">
                                    ${i.quantity}x ${i.product_name}
                                </span>
                            </div>
                            ${i.options?.length > 0 ? `<div class="text-xs text-gray-500 ml-4 italic">+ ${i.options.map(o => o.name).join(', ')}</div>` : ''}
                        `).join('')}
                        ${order.items.length > 3 ? `<div class="text-xs text-gray-500 italic">+ ${order.items.length - 3} items m√°s...</div>` : ''}
                    </div>
                    
                    <div class="flex justify-between items-center pt-2 border-t border-gray-200">
                        <span class="font-bold text-lg text-gray-900">$${parseFloat(order.total).toFixed(2)}</span>
                        <div class="flex gap-2">
                            <button onclick="event.stopPropagation(); printOrder(${order.id})" 
                                    class="p-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors"
                                    title="Imprimir">
                                <i class="fas fa-print text-sm"></i>
                            </button>
                            ${action ? `
                                <button onclick="event.stopPropagation(); updateOrderStatus(${order.id}, '${action.next}')" 
                                        class="px-3 py-2 ${action.color} text-white text-sm rounded-lg hover:opacity-80 transition-opacity flex items-center gap-1">
                                    <i class="fas ${action.icon}"></i>
                                    ${action.label}
                                </button>
                            ` : ''}
                        </div>
                    </div>
                    
                    ${isUrgent ? '<div class="mt-2 text-xs text-red-600 font-bold flex items-center gap-1"><i class="fas fa-exclamation-circle"></i> Pedido demorado</div>' : ''}
                </div>
            `;
        }

        // Actualizar estad√≠sticas
        function updateStats() {
            const today = new Date().toDateString();
            const todayOrders = orders.filter(o => new Date(o.createdAt).toDateString() === today);
            
            // Tiempo promedio de preparaci√≥n
            const completedOrders = orders.filter(o => o.status === 'delivered' && o.updatedAt);
            let avgTime = '--';
            if (completedOrders.length > 0) {
                const totalMinutes = completedOrders.reduce((acc, o) => {
                    const start = new Date(o.createdAt);
                    const end = new Date(o.updatedAt);
                    return acc + (end - start) / 60000;
                }, 0);
                avgTime = Math.round(totalMinutes / completedOrders.length) + ' min';
            }
            
            // Preparando ahora
            const preparing = orders.filter(o => o.status === 'preparing').length;
            
            // Completados hoy
            const completedToday = todayOrders.filter(o => o.status === 'delivered').length;
            
            // Ventas totales hoy
            const salesToday = todayOrders.reduce((acc, o) => acc + parseFloat(o.total), 0);
            
            document.getElementById('avg-time').textContent = avgTime;
            document.getElementById('stat-preparing').textContent = preparing;
            document.getElementById('stat-completed').textContent = completedToday;
            document.getElementById('stat-sales').textContent = '$' + salesToday.toFixed(2);
            
            // Actualizar resumen en header
            document.getElementById('stats-summary').textContent = 
                `${todayOrders.length} pedidos hoy ‚Ä¢ $${salesToday.toFixed(2)} en ventas`;
        }

        // Formatear tiempo
        function formatTime(minutes) {
            if (minutes < 60) return `${minutes}m`;
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return `${hours}h ${mins}m`;
        }

        // Actualizar timers cada minuto
        setInterval(() => {
            orders.forEach(o => {
                const timerEl = document.getElementById(`timer-${o.id}`);
                if (timerEl) {
                    const diff = Math.floor((new Date() - new Date(o.createdAt)) / 60000);
                    timerEl.textContent = formatTime(diff);
                    
                    // Recargar si cambia de categor√≠a de urgencia
                    if ((diff === 15 || diff === 10) && (o.status === 'pending' || o.status === 'preparing')) {
                        renderOrders();
                    }
                }
            });
        }, 60000);

        // Drag and Drop
        function drag(ev, orderId) {
            ev.dataTransfer.setData("orderId", orderId);
            ev.target.classList.add('dragging');
        }

        function allowDrop(ev) {
            ev.preventDefault();
            ev.currentTarget.classList.add('drag-over');
        }

        function leaveDrop(ev) {
            ev.currentTarget.classList.remove('drag-over');
        }

        function drop(ev, newStatus) {
            ev.preventDefault();
            ev.currentTarget.classList.remove('drag-over');
            const orderId = ev.dataTransfer.getData("orderId");
            if (orderId) {
                updateOrderStatus(parseInt(orderId), newStatus);
            }
        }

        // Actualizar estado
        async function updateOrderStatus(id, status) {
            try {
                const res = await fetch(`/api/orders/${id}/status`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status })
                });
                
                if (res.status === 401) {
                    window.location.replace('/login');
                    return;
                }
                
                if (!res.ok) throw new Error('Error en la actualizaci√≥n');
                
                showToast(`Pedido #${id} ‚Üí ${translateStatus(status)}`, 'success');
                loadOrders();
            } catch (err) {
                showToast('Error: ' + err.message, 'error');
            }
        }

        // Detalle de pedido
        function showOrderDetail(id) {
            const order = orders.find(o => o.id === id);
            if (!order) return;
            
            const modal = document.getElementById('order-modal');
            const content = document.getElementById('modal-content');
            
            content.innerHTML = `
                <div class="space-y-4">
                    <div class="flex justify-between items-center pb-4 border-b">
                        <div>
                            <div class="text-2xl font-bold">Pedido #${order.id}</div>
                            <div class="text-gray-600">Mesa ${order.table_code}</div>
                        </div>
                        <span class="px-3 py-1 rounded-full text-sm font-medium ${getStatusColor(order.status)}">
                            ${translateStatus(order.status)}
                        </span>
                    </div>
                    
                    <div class="space-y-2">
                        ${order.items.map(i => `
                            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                <div>
                                    <div class="font-semibold">${i.quantity}x ${i.product_name}</div>
                                    ${i.options?.length > 0 ? `<div class="text-sm text-gray-500">+ ${i.options.map(o => `${o.name} ($${o.price})`).join(', ')}</div>` : ''}
                                </div>
                                <div class="font-bold">$${(i.price * i.quantity).toFixed(2)}</div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="border-t pt-4 space-y-2">
                        <div class="flex justify-between text-sm">
                            <span>Subtotal</span>
                            <span>$${order.subtotal.toFixed(2)}</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span>Impuestos</span>
                            <span>$${order.tax.toFixed(2)}</span>
                        </div>
                        <div class="flex justify-between text-xl font-bold">
                            <span>Total</span>
                            <span>$${order.total.toFixed(2)}</span>
                        </div>
                    </div>
                    
                    <div class="text-xs text-gray-500 pt-2">
                        Creado: ${new Date(order.createdAt).toLocaleString()}<br>
                        ${order.updatedAt ? `Actualizado: ${new Date(order.updatedAt).toLocaleString()}` : ''}
                    </div>
                </div>
            `;
            
            modal.classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('order-modal').classList.add('hidden');
        }

        function getStatusColor(status) {
            const colors = {
                pending: 'bg-yellow-100 text-yellow-800',
                preparing: 'bg-blue-100 text-blue-800',
                ready: 'bg-green-100 text-green-800',
                delivered: 'bg-gray-100 text-gray-800'
            };
            return colors[status] || 'bg-gray-100 text-gray-800';
        }

        function translateStatus(status) {
            const translations = {
                pending: 'Pendiente',
                preparing: 'En preparaci√≥n',
                ready: 'Listo',
                delivered: 'Entregado'
            };
            return translations[status] || status;
        }

        // Imprimir pedido
        function printOrder(id) {
            const order = orders.find(o => o.id === id);
            if (!order) return;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Pedido #${order.id}</title>
                    <style>
                        body { font-family: monospace; font-size: 14px; max-width: 300px; margin: 0 auto; padding: 20px; }
                        .center { text-align: center; }
                        .bold { font-weight: bold; }
                        .border { border-top: 1px dashed #000; margin: 10px 0; padding-top: 10px; }
                        .item { margin: 5px 0; }
                        .total { font-size: 18px; font-weight: bold; margin-top: 10px; }
                        @media print { body { max-width: none; } }
                    </style>
                </head>
                <body>
                    <div class="center bold" style="font-size: 18px;">LA BUENA MESA</div>
                    <div class="center">Pedido #${order.id}</div>
                    <div class="center">Mesa: ${order.table_code}</div>
                    <div class="center">${new Date(order.createdAt).toLocaleString()}</div>
                    <div class="border"></div>
                    ${order.items.map(i => `
                        <div class="item">
                            <div class="bold">${i.quantity}x ${i.product_name}</div>
                            ${i.options?.length > 0 ? `<div style="font-size: 12px; margin-left: 10px;">+ ${i.options.map(o => o.name).join(', ')}</div>` : ''}
                            <div style="text-align: right;">$${(i.price * i.quantity).toFixed(2)}</div>
                        </div>
                    `).join('')}
                    <div class="border"></div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>Subtotal:</span>
                        <span>$${order.subtotal.toFixed(2)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>Impuestos:</span>
                        <span>$${order.tax.toFixed(2)}</span>
                    </div>
                    <div class="total center">TOTAL: $${order.total.toFixed(2)}</div>
                    <div class="center" style="margin-top: 30px; font-size: 12px;">
                        ¬°Gracias por su visita!
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        // Toggle sonido
        function toggleSound() {
            soundEnabled = !soundEnabled;
            const btn = document.getElementById('sound-btn');
            if (soundEnabled) {
                btn.innerHTML = '<i class="fas fa-volume-up mr-2"></i>Sonido';
                btn.classList.remove('bg-gray-400');
                btn.classList.add('bg-gray-200');
            } else {
                btn.innerHTML = '<i class="fas fa-volume-mute mr-2"></i>Silencio';
                btn.classList.remove('bg-gray-200');
                btn.classList.add('bg-gray-400');
            }
        }

        function playSound() {
            const audio = document.getElementById('notif-sound');
            audio.volume = 0.5;
            audio.currentTime = 0;
            audio.play().catch(e => console.log('Audio bloqueado:', e));
        }

        function showBrowserNotification(title, body) {
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification(title, { 
                    body,
                    icon: '/favicon.ico',
                    badge: '/favicon.ico',
                    tag: 'new-order',
                    requireInteraction: true
                });
            }
        }

        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container') || createToastContainer();
            const toast = document.createElement('div');
            
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                info: 'bg-blue-500',
                warning: 'bg-yellow-500'
            };
            
            toast.className = `${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-3 transform transition-all duration-300 translate-x-full fixed top-4 right-4 z-50`;
            toast.innerHTML = `
                <i class="fas ${type === 'success' ? 'fa-check' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
                <span class="font-medium">${message}</span>
            `;
            
            container.appendChild(toast);
            setTimeout(() => toast.classList.remove('translate-x-full'), 100);
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function createToastContainer() {
            const container = document.createElement('div');
            container.id = 'toast-container';
            container.className = 'fixed top-4 right-4 z-50 space-y-2';
            document.body.appendChild(container);
            return container;
        }

        // Pedir permiso para notificaciones
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }

        // Atajos de teclado
        document.addEventListener('keydown', (e) => {
            // ESC cerrar modal
            if (e.key === 'Escape') {
                closeModal();
            }
            // R recargar
            if (e.key === 'r' || e.key === 'R') {
                if (!e.target.matches('input')) {
                    loadOrders();
                }
            }
            // S toggle sonido
            if (e.key === 's' || e.key === 'S') {
                if (!e.target.matches('input')) {
                    toggleSound();
                }
            }
        });

        // Actualizar cada 30 segundos como fallback
        setInterval(loadOrders, 30000);

        // Click fuera del modal para cerrar
        document.getElementById('order-modal').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) closeModal();
        });
    </script>
</body>
</html>